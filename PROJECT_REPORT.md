# Sport Agent MVP 项目报告

**报告日期**: 2025-11-27  
**项目阶段**: MVP 开发完成，生产就绪前测试阶段

---

## 一、项目概述

Sport Agent 是一个 **企业级 AI 足球分析助手**，采用多智能体架构，支持自然语言交互、智能预测和数据分析。

### 核心价值
- **自然语言交互**：用户可用中文提问足球相关问题
- **实时数据分析**：联赛积分榜、球队战绩、历史交锋
- **智能预测**：基于统计模型的比赛结果预测
- **多智能体协作**：Supervisor + Expert Agents 架构

---

## 二、开发进度

### 已完成功能

| 模块 | 状态 | 说明 |
|------|------|------|
| 数据层 | [待完善]  | 6大联赛数据导入、实体解析、增量更新 |
| Service 层 | [待完善] | DataService、StatsService、PredictService |
| Agent 层 | [待完善] 95% | DataStatsAgent、PredictionAgent、SupervisorAgent |
| API 层 | [待完善] 90% | FastAPI RESTful 接口 |
| ML 模型 | [待完善] 80% | 规则基线模型，XGBoost 特征工程就绪 |

### 待完成功能

| 功能 | 优先级 | 预计时间 |
|------|--------|---------|
| KnowledgeAgent (RAG) | P1 | 1周 |
| 用户画像系统 | P2 | 1周 |
| 推荐系统 | P2 | 2周 |
| A/B 测试框架 | P3 | 1周 |

---

## 三、技术架构

### 分层架构

```
+-------------------------------------------------------------+
|                    Interface Layer (API)                     |
|              FastAPI + Pydantic Request/Response             |
+----------------------------+--------------------------------+
                             |
+----------------------------v--------------------------------+
|                      Agent Layer                             |
|  +-----------------+  +--------------+  +----------------+  |
|  | SupervisorAgent |--| DataStats    |--| Prediction     |  |
|  | (任务调度)       |  | Agent        |  | Agent          |  |
|  +-----------------+  +--------------+  +----------------+  |
|              LangChain + Structured Chat Agent               |
+----------------------------+--------------------------------+
                             |
+----------------------------v--------------------------------+
|                     Service Layer                            |
|  +-------------+  +--------------+  +--------------------+  |
|  | DataService |  | StatsService |  | PredictService     |  |
|  | (数据访问)   |  | (统计分析)    |  | (预测逻辑)         |  |
|  +-------------+  +--------------+  +--------------------+  |
|                     纯 Python，无 LangChain                  |
+----------------------------+--------------------------------+
                             |
+----------------------------v--------------------------------+
|                      Infra Layer                             |
|  +-------------+  +--------------+  +--------------------+  |
|  | PostgreSQL  |  | EntityResolver|  | LLM Client        |  |
|  | (SQLAlchemy)|  | (实体解析)    |  | (Ollama/OpenAI)   |  |
|  +-------------+  +--------------+  +--------------------+  |
+-------------------------------------------------------------+
```

### 技术栈

| 类别 | 技术 | 版本 |
|------|------|------|
| **后端框架** | FastAPI | >=0.115 |
| **ORM** | SQLAlchemy | >=2.0 |
| **数据库** | PostgreSQL | 14+ |
| **AI/Agent** | LangChain | 最新 |
| **LLM** | Ollama (qwen2.5:7b) / OpenAI | 可切换 |
| **ML** | XGBoost, LightGBM, scikit-learn | 最新 |
| **数据处理** | Pandas, NumPy | >=2.2 |
| **缓存** | Redis | >=5.0 |
| **模型追踪** | MLflow | >=2.16 |
| **配置管理** | Pydantic Settings | >=2.4 |
| **数据库迁移** | Alembic | >=1.13 |

---

## 四、测试结果

### 4.1 单元测试

**测试日期**: 2025-11-27

| 测试文件 | 测试数 | 通过 | 失败 | 状态 |
|----------|--------|------|------|------|
| test_data_service.py | 6 | 6 | 0 | [通过] |
| test_stats_service.py | 8 | 8 | 0 | [通过] |
| **总计** | **14** | **14** | **0** | **全部通过** |

### 4.2 交互测试结果

| 测试场景 | 查询示例 | 结果 | 说明 |
|----------|----------|------|------|
| 英超积分榜 | "水晶宫" | [通过] | 正确返回排名和积分 |
| 比赛预测 | "水晶宫和诺丁汉森林谁厉害" | [通过] | 正确返回概率分析 |
| 西甲查询 | "巴萨最近的战绩" | [失败] | 数据库中无西甲比赛数据 |
| 上下文追问 | "皇马积分" | [部分] | 需要明确联赛信息 |

### 4.3 已知问题

1. **西甲/意甲数据缺失**
   - 现象：查询巴萨、皇马等球队时显示"未找到数据"
   - 原因：数据库中西甲比赛数据未完整导入
   - 解决：运行 `python src/data_pipeline/ingest_football_data_v2.py` 补充数据

2. **上下文理解有限**
   - 现象：追问时 Agent 可能不调用工具直接回复
   - 原因：前一轮对话失败后上下文干扰
   - 缓解：新开会话或明确完整问题

---

## 五、已实现功能详解

### 5.1 自然语言理解

| 功能 | 示例 | 状态 |
|------|------|------|
| 球队近况查询 | "曼联最近5场战绩" | [完成] |
| 积分榜查询 | "英超积分榜前5" | [完成] |
| 比赛预测 | "维拉和热刺谁会赢" | [完成] |
| 球队对比 | "水晶宫和诺丁汉森林谁厉害" | [完成] |
| 中文别名识别 | 巴萨/皇马/曼联/红魔/大巴黎 等50+别名 | [完成] |
| 上下文追问 | "那利物浦呢" | [完成] |

### 5.2 实体解析系统

```python
# 支持的中文别名示例
"巴萨" -> FC Barcelona
"皇马" -> Real Madrid
"曼联/红魔" -> Manchester United
"曼城/蓝月亮" -> Manchester City
"拜仁/南大王" -> Bayern Munchen
"大巴黎" -> PSG
"维拉" -> Aston Villa
"药厂" -> Bayer Leverkusen
"黄潜" -> Villarreal
# 共 50+ 中文别名映射
```

### 5.3 数据覆盖

| 联赛 | 代码 | 球队数 | 比赛数 |
|------|------|--------|--------|
| 英超 | PL | 20 | 380+/赛季 |
| 德甲 | BL1 | 18 | 306+/赛季 |
| 西甲 | PD | 20 | 380+/赛季 |
| 意甲 | SA | 20 | 380+/赛季 |
| 法甲 | FL1 | 18 | 306+/赛季 |
| 欧冠 | CL | 32+ | 125+/赛季 |

**总计**: 107 支球队，443+ 别名映射

### 5.4 预测模型

**当前模型**: 规则基线模型 (baseline_v1.0)

考虑因素:
- 近期战绩（胜率、进球、失球）
- 主场优势
- 历史交锋
- 积分榜位置
- 赛程疲劳度

输出:
- 胜/平/负概率分布
- 置信度
- 关键影响因素
- 数据质量评分

---

## 六、后期开发准备

### 6.1 架构设计

| 准备项 | 状态 | 说明 |
|--------|------|------|
| 分层架构 | [完成] | API / Agent / Service / Infra 四层分离 |
| 依赖注入 | [完成] | FastAPI Depends 模式 |
| 配置管理 | [完成] | Pydantic Settings + YAML |
| 数据库迁移 | [完成] | Alembic 版本控制 |
| 日志系统 | [完成] | Loguru 结构化日志 |

### 6.2 代码质量

| 准备项 | 状态 | 说明 |
|--------|------|------|
| 类型提示 | [完成] | 全项目 Type Hints |
| Pydantic 模型 | [完成] | 请求/响应/工具 Schema |
| 文档字符串 | [完成] | 函数级文档 |
| 错误处理 | [完成] | 统一异常处理 |

### 6.3 可扩展性

| 准备项 | 状态 | 说明 |
|--------|------|------|
| LLM 可切换 | [完成] | 支持 Ollama/OpenAI/DeepSeek |
| 新 Agent 扩展 | [完成] | ExpertRegistry 注册机制 |
| 新数据源扩展 | [完成] | EntityResolver 动态加载 |
| 多联赛扩展 | [完成] | 配置驱动 |

### 6.4 运维准备

| 准备项 | 状态 | 说明 |
|--------|------|------|
| Docker 化 | [完成] | docker-compose.yaml |
| 环境变量管理 | [完成] | .env + pydantic-settings |
| 健康检查 | [进行中] | API 端点待添加 |
| 监控指标 | [进行中] | Prometheus 集成待添加 |
| CI/CD | [待开始] | 待配置 |

### 6.5 ML 工程化

| 准备项 | 状态 | 说明 |
|--------|------|------|
| 特征工程 | [完成] | match_features.py |
| 模型训练 | [完成] | train_baseline.py |
| 模型版本 | [完成] | MLflow 集成就绪 |
| 模型服务 | [进行中] | BentoML 集成待完成 |

---

## 七、项目结构

```
sport agent mvp/
├── src/
│   ├── agent/              # Agent 层（LangChain）
│   │   ├── data_stats_agent.py   # 数据统计专家
│   │   ├── prediction_agent.py   # 预测专家
│   │   └── tools/                 # LangChain 工具
│   │
│   ├── supervisor/         # 监督智能体
│   │   ├── supervisor_agent.py   # 任务调度
│   │   └── expert_registry.py    # 专家注册
│   │
│   ├── services/           # Service 层（纯 Python）
│   │   ├── data_service.py       # 数据访问
│   │   ├── stats_service.py      # 统计分析
│   │   ├── predict_service.py    # 预测逻辑
│   │   └── api/                   # FastAPI 接口
│   │
│   ├── data_pipeline/      # 数据管道
│   │   ├── entity_resolver.py    # 实体解析（50+别名）
│   │   └── ingest_football_data_v2.py  # 数据导入
│   │
│   ├── infra/db/           # 基础设施
│   │   ├── models.py             # SQLAlchemy 模型
│   │   └── session.py            # 数据库连接
│   │
│   ├── ml/                 # 机器学习
│   │   ├── features/             # 特征工程
│   │   ├── models/               # 模型定义
│   │   └── training/             # 训练脚本
│   │
│   └── shared/             # 共享模块
│       ├── llm_client_v2.py      # LLM 客户端
│       └── config.py             # 配置管理
│
├── scripts/                # 运维脚本
│   ├── chat_interactive.py       # 交互式测试
│   ├── ingest_full_season.py     # 数据导入
│   └── manage_team_aliases.py    # 别名管理
│
├── tests/                  # 测试文件
│   ├── services/                 # 服务层测试 (14个全部通过)
│   └── api/                      # API 测试
│
├── config/                 # 配置文件
├── alembic/                # 数据库迁移
└── docs/                   # 文档
```

---

## 八、下一步计划

### 短期（1-2周）

1. **数据完善**
   - 补充西甲、意甲比赛数据
   - 验证所有联赛数据完整性

2. **KnowledgeAgent 开发**
   - RAG 系统集成
   - 足球规则/战术知识库

3. **性能优化**
   - 缓存策略（Redis）
   - 查询优化

### 中期（2-4周）

1. **用户系统**
   - 用户画像
   - 偏好学习

2. **推荐系统**
   - 比赛推荐
   - 个性化分析

3. **生产部署**
   - K8s 配置
   - CI/CD 流水线

---

## 九、使用指南

### 快速启动

```bash
# 1. 激活环境
source .venv/bin/activate

# 2. 启动服务
docker-compose up -d postgres redis
brew services start ollama

# 3. 交互测试
python scripts/chat_interactive.py
```

### 示例对话

```
你: 曼联最近状态如何？
Agent: 曼联最近5场：1胜2平2负，状态一般...

你: 水晶宫积分多少？
Agent: 水晶宫在英超排名第5位，积分20分...

你: 水晶宫和诺丁汉森林谁会赢？
Agent: 根据分析，水晶宫获胜概率49.5%，双方实力接近...
```

---
**技术栈**: Python 3.9+ / FastAPI / LangChain / PostgreSQL / Ollama