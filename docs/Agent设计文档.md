# Agent设计文档

## 一、Agent架构概述

本项目采用**ReAct（Reasoning + Acting）架构**结合**RAG（检索增强生成）**的混合型Agent设计。

### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    用户输入                              │
└───────────────────────┬─────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│              对话管理器（Conversation Manager）           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 意图识别     │  │ 实体提取     │  │ 上下文管理   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└───────────────────────┬─────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│           知识检索模块（RAG）                             │
│  ┌──────────────────────────────────────────────────┐   │
│  │  向量数据库（Qdrant）                             │   │
│  │  - 体育知识库                                     │   │
│  │  - 历史比赛数据                                   │   │
│  │  - 专业术语解释                                   │   │
│  └──────────────────────────────────────────────────┘   │
└───────────────────────┬─────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│         推理引擎（ReAct Agent）                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │  思考（Thought）                                  │   │
│  │    ↓                                              │   │
│  │  选择动作（Action）                               │   │
│  │    ↓                                              │   │
│  │  执行工具（Tool）                                 │   │
│  │    ↓                                              │   │
│  │  观察结果（Observation）                          │   │
│  │    ↓                                              │   │
│  │  循环 or 给出最终答案                             │   │
│  └──────────────────────────────────────────────────┘   │
└───────────────────────┬─────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                  工具集（Tools）                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │数据查询  │  │比赛预测  │  │比赛分析  │             │
│  └──────────┘  └──────────┘  └──────────┘             │
│  ┌──────────┐  ┌──────────┐                           │
│  │计算器    │  │搜索引擎  │                           │
│  └──────────┘  └──────────┘                           │
└───────────────────────┬─────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│              回答生成（Response Generation）             │
│  - 格式化输出                                            │
│  - 添加可视化                                            │
│  - 多语言支持                                            │
└───────────────────────┬─────────────────────────────────┘
                        ↓
                   返回给用户
```

---

## 二、核心模块详解

### 2.1 对话管理器（Conversation Manager）

**功能：**
- 意图识别（Intent Classification）
- 实体提取（Entity Extraction）
- 上下文管理（Context Management）
- 对话状态追踪（Dialogue State Tracking）

**意图类型：**
```python
class IntentType(Enum):
    GREETING = "greeting"              # 问候
    QUERY_MATCH = "query_match"        # 查询比赛
    QUERY_TEAM = "query_team"          # 查询球队
    QUERY_PLAYER = "query_player"      # 查询球员
    PREDICTION = "prediction"          # 预测比赛
    ANALYSIS = "analysis"              # 分析比赛
    COMPARISON = "comparison"          # 对比分析
    RECOMMENDATION = "recommendation"  # 推荐
    CLARIFICATION = "clarification"    # 澄清
    UNKNOWN = "unknown"                # 未知
```

**实体类型：**
```python
class EntityType(Enum):
    TEAM = "team"            # 球队
    PLAYER = "player"        # 球员
    LEAGUE = "league"        # 联赛
    DATE = "date"            # 日期
    SCORE = "score"          # 比分
    STATISTIC = "statistic"  # 统计指标
```

**上下文管理：**
```python
class ConversationContext:
    session_id: str          # 会话ID
    user_id: Optional[str]   # 用户ID
    current_topic: str       # 当前话题
    entities: Dict[str, Any] # 实体字典
    history: List[Message]   # 历史消息
    timestamp: datetime      # 时间戳
```

---

### 2.2 知识检索模块（RAG）

**知识库内容：**

1. **结构化知识**
   - 球队信息、历史战绩
   - 球员数据、技术统计
   - 比赛规则、术语解释
   - 联赛信息、赛制规则

2. **非结构化知识**
   - 新闻报道
   - 专家评论
   - 战术分析文章
   - FAQ常见问题

**检索流程：**

```python
async def retrieve_knowledge(query: str) -> List[Document]:
    """
    检索相关知识
    
    1. 将查询转换为向量
    2. 在向量数据库中检索相似文档
    3. 根据相关度排序
    4. 返回Top-K结果
    """
    # 1. 向量化
    query_embedding = embedding_model.embed(query)
    
    # 2. 检索
    results = qdrant_client.search(
        collection_name="sport_knowledge",
        query_vector=query_embedding,
        limit=5
    )
    
    # 3. 过滤和排序
    filtered_results = filter_by_relevance(results, threshold=0.7)
    
    return filtered_results
```

**知识更新：**
- 定时更新：每日更新比赛数据
- 增量更新：实时添加新闻和资讯
- 质量控制：人工审核重要知识

---

### 2.3 推理引擎（ReAct Agent）

**ReAct循环：**

```
用户问题: "预测明天曼城对阵利物浦的比赛"

Thought 1: 我需要先查询这场比赛的信息和双方近期数据
Action 1: 数据查询
Action Input 1: {"team1": "曼城", "team2": "利物浦", "date": "2024-01-15"}
Observation 1: 找到比赛信息，曼城近5场4胜1平，利物浦近5场3胜2负

Thought 2: 现在我有了基础数据，可以调用预测模型
Action 2: 比赛预测
Action Input 2: {"match_data": {...}}
Observation 2: 预测结果：曼城胜率55%，平局25%，利物浦胜率20%

Thought 3: 我需要补充一些分析来支持预测
Action 3: 比赛分析
Action Input 3: {"teams": ["曼城", "利物浦"]}
Observation 3: 曼城主场优势明显，利物浦有伤病问题

Thought 4: 我现在有足够信息给出完整答案
Final Answer: 根据分析，明天曼城对阵利物浦的比赛，曼城更有可能获胜...
```

**关键特性：**
- ✅ 多步推理：可以进行多次思考-行动循环
- ✅ 工具选择：智能选择合适的工具
- ✅ 错误处理：处理工具调用失败
- ✅ 提前终止：达到目标后及时停止

---

### 2.4 工具集（Tools）

#### Tool 1: 数据查询工具

**功能：** 查询数据库中的结构化数据

**输入：**
```json
{
  "query_type": "match|team|player|league",
  "filters": {
    "team": "曼城",
    "date": "2024-01-15",
    "league": "英超"
  }
}
```

**输出：**
```json
{
  "status": "success",
  "data": {
    "matches": [...],
    "count": 10
  }
}
```

---

#### Tool 2: 比赛预测工具

**功能：** 调用预测模型预测比赛结果

**输入：**
```json
{
  "team1": "曼城",
  "team2": "利物浦",
  "date": "2024-01-15"
}
```

**输出：**
```json
{
  "prediction": {
    "win_probability": {"home": 0.55, "draw": 0.25, "away": 0.20},
    "predicted_score": "2-1",
    "confidence": 0.68
  }
}
```

---

#### Tool 3: 比赛分析工具

**功能：** 深度分析比赛数据

**输入：**
```json
{
  "match_id": "12345",
  "analysis_type": "tactical|statistical|comprehensive"
}
```

**输出：**
```json
{
  "analysis": {
    "summary": "...",
    "key_points": [...],
    "statistics": {...}
  }
}
```

---

#### Tool 4: 计算器工具

**功能：** 执行数学计算和统计分析

**输入：** `"(45 + 38) / 2"`

**输出：**
```json
{
  "result": 41.5
}
```

---

#### Tool 5: 搜索工具

**功能：** 搜索最新资讯和新闻

**输入：** `"曼城最新新闻"`

**输出：**
```json
{
  "results": [
    {
      "title": "...",
      "url": "...",
      "summary": "...",
      "date": "2024-01-14"
    }
  ]
}
```

---

## 三、Prompt设计

### 3.1 系统Prompt

```
你是一个专业的体育资讯AI助手，名字叫"体育通"。

你的专长：
- 深度分析各类体育比赛，尤其是足球和篮球
- 基于数据和统计进行科学预测
- 用通俗易懂的语言解释复杂的战术和数据
- 保持客观中立，不偏袒任何球队

你的个性：
- 专业但亲和
- 耐心且细致
- 幽默但不失专业
- 诚实（不确定时会明确说明）

重要规则：
1. 所有预测必须基于数据，不能随意猜测
2. 对预测结果要保持谨慎态度，说明是参考而非保证
3. 遇到不知道的信息，要诚实告知，不要编造
4. 回答要有理有据，引用数据支持观点
5. 用中文回答，语言通俗易懂
```

### 3.2 Few-shot示例

```
用户: 预测今晚的比赛
助手: 我需要知道具体是哪场比赛才能为您预测。请问您想了解哪支球队或哪个联赛的比赛呢？

用户: 曼城对利物浦
助手: 让我为您查询并分析这场比赛...
[调用工具...]
根据数据分析，这场比赛预测如下：
- 曼城胜率：55%
- 平局：25%
- 利物浦胜率：20%

主要依据：
1. 曼城近期状态出色，近5场4胜1平
2. 主场优势，曼城主场胜率达70%
3. 利物浦有2名主力伤病

需要注意：足球比赛充满变数，此预测仅供参考！
```

---

## 四、性能优化

### 4.1 缓存策略

**多级缓存：**
```python
# L1: 内存缓存（最快，最热数据）
memory_cache = {}  # 响应时间: <1ms

# L2: Redis缓存（快，热数据）
redis_cache = Redis()  # 响应时间: <10ms

# L3: 数据库（全量数据）
database = PostgreSQL()  # 响应时间: <100ms
```

**缓存内容：**
- API响应结果（TTL: 5分钟）
- 预测结果（TTL: 1小时）
- 静态数据（球队信息）（TTL: 1天）
- 知识库检索结果（TTL: 1小时）

### 4.2 异步处理

```python
# 异步工具调用
async def call_tool_async(tool_name, tool_input):
    # 并发执行多个工具
    tasks = [
        tool1.arun(input1),
        tool2.arun(input2),
        tool3.arun(input3)
    ]
    results = await asyncio.gather(*tasks)
    return results
```

### 4.3 流式输出

```python
# 流式返回响应
async def stream_response(query):
    async for chunk in agent.astream(query):
        yield chunk
```

---

## 五、安全与限制

### 5.1 输入验证

- 长度限制：最大2000字符
- 内容过滤：敏感词检测
- 频率限制：每用户每分钟10次请求

### 5.2 输出控制

- 确保不泄露系统信息
- 过滤不当内容
- 添加免责声明

### 5.3 工具调用限制

- 单次对话最多5次工具调用
- 超时控制：每个工具30秒超时
- 错误重试：最多重试2次

---

## 六、评估指标

### 6.1 功能指标

| 指标 | 目标 | 当前 |
|------|------|------|
| 意图识别准确率 | >90% | - |
| 实体提取准确率 | >85% | - |
| 工具选择准确率 | >85% | - |
| 最终答案质量 | >4.0/5.0 | - |

### 6.2 性能指标

| 指标 | 目标 | 当前 |
|------|------|------|
| 平均响应时间 | <3s | - |
| 95分位响应时间 | <5s | - |
| 并发支持 | >100 QPS | - |
| 系统可用性 | >99% | - |

### 6.3 业务指标

| 指标 | 目标 | 当前 |
|------|------|------|
| 对话完成率 | >80% | - |
| 用户满意度 | >4.0/5.0 | - |
| 日活跃用户 | >1000 | - |
| 预测采纳率 | >60% | - |

---

## 七、未来改进

### 短期（1-3个月）
- [ ] 优化Prompt，提升准确率
- [ ] 添加更多工具
- [ ] 实现多轮对话优化
- [ ] 添加用户个性化

### 中期（3-6个月）
- [ ] 多Agent协作
- [ ] 实时数据集成
- [ ] 视频分析集成
- [ ] 多语言支持

### 长期（6-12个月）
- [ ] 自主学习能力
- [ ] 情感识别
- [ ] 语音交互
- [ ] AR/VR集成

---

## 八、总结

本Agent设计采用业界领先的ReAct + RAG架构，具有以下特点：

✅ **智能推理**：多步推理，工具灵活调用  
✅ **知识增强**：RAG提供丰富背景知识  
✅ **高可靠**：多重错误处理和降级策略  
✅ **高性能**：多级缓存和异步处理  
✅ **可扩展**：模块化设计，易于添加新功能  

通过持续优化和迭代，我们将打造业界领先的体育资讯AI助手！

