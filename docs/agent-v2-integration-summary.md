# Agent V2.0 é›†æˆå®Œæˆæ€»ç»“

## ğŸ“… å®Œæˆæ—¶é—´
2025-11-24

---

## ğŸ¯ ä»»åŠ¡ç›®æ ‡

å°†ç°æœ‰çš„æ‰‹åŠ¨å·¥å…·è°ƒç”¨æ¶æ„å‡çº§ä¸º**ç»Ÿä¸€çš„ Orchestrator æ¶æ„**ï¼Œæ”¯æŒï¼š
- çœŸå®å·¥å…·å’Œ Mock å·¥å…·æ··åˆä½¿ç”¨
- æ›´å¥½çš„å‚æ•°è§£æå’Œç»‘å®š
- è¯¦ç»†çš„æ‰§è¡Œè¿½è¸ª
- å‘åå…¼å®¹æ€§

---

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»º AgentServiceV2 (`agent_v2.py`)

**æ ¸å¿ƒæ¶æ„**ï¼š
```
ç”¨æˆ·æŸ¥è¯¢
    â†“
Planner (æ„å›¾è¯†åˆ«)
    â†“
ParameterResolver (å‚æ•°è§£æ)
    â†“
Executor (æ™ºèƒ½è·¯ç”±)
    â”œâ”€ çœŸå®å·¥å…· (MatchTool)
    â””â”€ Mock å·¥å…· (å…¶ä»–)
    â†“
LLM Generator (å›ç­”ç”Ÿæˆ)
    â†“
å“åº”
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… æ™ºèƒ½å·¥å…·è·¯ç”±ï¼ˆè‡ªåŠ¨é€‰æ‹©çœŸå®/Mockï¼‰
- âœ… ç»Ÿä¸€çš„å‚æ•°è§£ææµç¨‹
- âœ… è¯¦ç»†çš„æ‰§è¡Œæ—¶é—´è¿½è¸ª
- âœ… æ”¹è¿›çš„é”™è¯¯å¤„ç†
- âœ… å·¥å…·æ³¨å†Œè¡¨æœºåˆ¶

### 2. æ›´æ–°ä¾èµ–æ³¨å…¥ (`dependencies.py`)

```python
# æ–°å¢ V2 ä¾èµ–
@lru_cache(maxsize=1)
def get_agent_service_v2() -> AgentServiceV2:
    settings = get_settings()
    return AgentServiceV2(settings=settings)
```

### 3. æ·»åŠ  V2 API ç«¯ç‚¹ (`routers/agent.py`)

```python
@router.post("/query/v2", response_model=AgentResponse)
async def agent_query_v2(
    payload: AgentQuery,
    service: AgentServiceV2 = Depends(get_agent_service_v2),
) -> AgentResponse:
    ...
```

### 4. åˆ›å»ºæµ‹è¯•è„šæœ¬ (`test_agent_v2.py`)

æä¾›å®Œæ•´çš„ V1 vs V2 å¯¹æ¯”æµ‹è¯•ã€‚

---

## ğŸ“Š V1 vs V2 å¯¹æ¯”

| ç»´åº¦ | V1 (æ—§ç‰ˆ) | V2 (æ–°ç‰ˆ) | æ”¹è¿› |
|-----|----------|----------|------|
| **æ¶æ„** | æ‰‹åŠ¨å·¥å…·è°ƒç”¨ | Orchestratorç»Ÿä¸€æ¶æ„ | â¬†ï¸ æ›´æ¸…æ™° |
| **å·¥å…·è·¯ç”±** | ç¡¬ç¼–ç  | æ™ºèƒ½è·¯ç”±æ³¨å†Œè¡¨ | â¬†ï¸ æ›´çµæ´» |
| **å‚æ•°è§£æ** | ç®€å•å­—ç¬¦ä¸²åŒ¹é… | ParameterResolver | â¬†ï¸ æ›´å‡†ç¡® |
| **æ‰§è¡Œè¿½è¸ª** | æ¨¡æ‹Ÿå»¶è¿Ÿ | çœŸå®è€—æ—¶+æ¥æºæ ‡è®° | â¬†ï¸ æ›´é€æ˜ |
| **é”™è¯¯å¤„ç†** | åŸºç¡€ try/catch | åˆ†å±‚é”™è¯¯å¤„ç† | â¬†ï¸ æ›´å¥å£® |
| **æ‰©å±•æ€§** | æ¯ä¸ªå·¥å…·éœ€ä¿®æ”¹ä»£ç  | æ³¨å†Œè¡¨é©±åŠ¨ | â¬†ï¸ æ˜“æ‰©å±• |
| **Planner Version** | v1.2 | v2.0 | â¬†ï¸ ç‰ˆæœ¬æ ‡è¯† |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹
```json
{
  "query": "æ›¼è”æœ€è¿‘çš„æ¯”èµ›æ€ä¹ˆæ ·ï¼Ÿ"
}
```

### V1 å“åº”
```json
{
  "planner_version": "v1.2",
  "tool_traces": [
    {
      "tool_name": "MatchResolverTool",
      "latency_ms": 10,  // æ¨¡æ‹Ÿå»¶è¿Ÿ
      "output_snippet": "ğŸ“Š æ›¼è” (MUN) è¿‘ 5 åœºæ¯”èµ›è®°å½•..."
    }
  ]
}
```

### V2 å“åº”
```json
{
  "planner_version": "v2.0",
  "tool_traces": [
    {
      "tool_name": "MatchResolverTool",
      "latency_ms": 39,  // çœŸå®æ•°æ®åº“æŸ¥è¯¢è€—æ—¶
      "input_payload": {"query": "'æ›¼è”æœ€è¿‘çš„æ¯”èµ›æ€ä¹ˆæ ·ï¼Ÿ'"},
      "output_snippet": "ğŸ“Š æ›¼è” (MUN) è¿‘ 5 åœºæ¯”èµ›è®°å½•..."
    },
    {
      "tool_name": "LLMAugmentorTool",
      "latency_ms": 0,
      "input_payload": {"context": "$tool_outputs"},
      "output_snippet": "è¿”å› 2 é¡¹æ•°æ®"
    }
  ]
}
```

**å…³é”®å·®å¼‚**ï¼š
- âœ… V2 æ˜¾ç¤ºçœŸå®è€—æ—¶ï¼ˆ39ms vs 10msï¼‰
- âœ… V2 æä¾›è¯¦ç»†çš„ input_payload
- âœ… V2 æ ‡è®°å·¥å…·æ¥æºï¼ˆreal/mockï¼‰

---

## ğŸ”§ å·¥å…·æ³¨å†Œæœºåˆ¶

### æ³¨å†Œè¡¨ç»“æ„
```python
self._real_tools = {
    "MatchResolverTool": match_tool.get_recent_matches,
    # åç»­æ·»åŠ ï¼š
    # "StatsTool": stats_tool.get_team_stats,
    # "NewsTool": news_tool.search_news,
    # "PredictionTool": prediction_tool.predict,
}
```

### æ™ºèƒ½è·¯ç”±é€»è¾‘
```python
if tool_name in self._real_tools:
    # è°ƒç”¨çœŸå®å·¥å…·
    result = await self._execute_real_tool(...)
    source = "real"
else:
    # è°ƒç”¨ Mock å·¥å…·
    result = self._execute_mock_tool(...)
    source = "mock"
```

---

## ğŸ“‚ æ–°å¢/ä¿®æ”¹æ–‡ä»¶

```
src/services/api/services/
â”œâ”€â”€ agent.py                âœ“ ä¿ç•™ (V1 å…¼å®¹)
â””â”€â”€ agent_v2.py            âœ¨ NEW - V2 ç»Ÿä¸€æ¶æ„

src/services/api/
â”œâ”€â”€ dependencies.py         ğŸ“ æ›´æ–° - æ·»åŠ  V2 ä¾èµ–
â””â”€â”€ routers/
    â””â”€â”€ agent.py           ğŸ“ æ›´æ–° - æ·»åŠ  /query/v2 ç«¯ç‚¹

scripts/
â””â”€â”€ test_agent_v2.py       âœ¨ NEW - V2 æµ‹è¯•è„šæœ¬

docs/
â””â”€â”€ agent-v2-integration-summary.md  âœ¨ NEW - æœ¬æ–‡æ¡£
```

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### æ–¹å¼ 1: ç›´æ¥åˆ‡æ¢åˆ° V2

```python
# ä¿®æ”¹ router.py çš„é»˜è®¤è·¯ç”±
@router.post("/query")  # å°† V2 è®¾ä¸ºé»˜è®¤
async def agent_query(
    payload: AgentQuery,
    service: AgentServiceV2 = Depends(get_agent_service_v2),
):
    return await service.run_query(payload)
```

### æ–¹å¼ 2: åŒç‰ˆæœ¬å¹¶å­˜ï¼ˆæ¨èï¼‰

```bash
# V1: æ—§å®¢æˆ·ç«¯ç»§ç»­ä½¿ç”¨
POST /api/v1/agent/query

# V2: æ–°å®¢æˆ·ç«¯ä½¿ç”¨
POST /api/v1/agent/query/v2
```

### æ–¹å¼ 3: ç°åº¦å‘å¸ƒ

```python
# æ ¹æ®ç”¨æˆ· ID è·¯ç”±
if user_id % 10 < 3:  # 30% æµé‡
    service = get_agent_service_v2()
else:
    service = get_agent_service()
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### çœŸå®ç¯å¢ƒæµ‹è¯•

| æŒ‡æ ‡ | V1 | V2 | è¯´æ˜ |
|-----|----|----|------|
| æ•°æ®åº“æŸ¥è¯¢ | æ¨¡æ‹Ÿ | çœŸå® | V2 æŸ¥è¯¢å®é™…æ•°æ® |
| å»¶è¿Ÿè¿½è¸ª | å›ºå®šå€¼ | åŠ¨æ€æµ‹é‡ | V2 åæ˜ çœŸå®è€—æ—¶ |
| å·¥å…·æ¥æº | æ— æ ‡è®° | real/mock | V2 å¯å®¡è®¡ |
| å‚æ•°è§£æ | æ­£åˆ™æå– | ParameterResolver | V2 æ›´å‡†ç¡® |

---

## ğŸ”® åç»­ä¼˜åŒ–

### çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰

1. **æ·»åŠ æ›´å¤šçœŸå®å·¥å…·**
   - âœ… MatchResolverTool (å·²å®Œæˆ)
   - â³ StatsTool (ä¸‹ä¸€æ­¥)
   - â³ NewsTool
   - â³ PredictionTool

2. **æ”¹è¿›å®ä½“è¯†åˆ«**
   - é›†æˆ EntityResolver
   - æ”¯æŒæ›´å¤šçƒé˜Ÿåˆ«å
   - è·¨è¯­è¨€å®ä½“å¯¹é½

3. **æ€§èƒ½ä¼˜åŒ–**
   - å·¥å…·å¹¶è¡Œæ‰§è¡Œ
   - ç»“æœç¼“å­˜
   - è¿æ¥æ± ç®¡ç†

### ä¸­æœŸï¼ˆ2-4å‘¨ï¼‰

4. **é«˜çº§ç‰¹æ€§**
   - å·¥å…·é“¾ç¼–æ’ï¼ˆä¾èµ–å…³ç³»ï¼‰
   - æ¡ä»¶åˆ†æ”¯æ‰§è¡Œ
   - å¾ªç¯å’Œé‡è¯•ç­–ç•¥

5. **ç›‘æ§ä¸æ—¥å¿—**
   - Prometheus æŒ‡æ ‡å¯¼å‡º
   - åˆ†å¸ƒå¼è¿½è¸ª (Jaeger)
   - æ€§èƒ½åˆ†æä»ªè¡¨æ¿

6. **å®‰å…¨æ€§**
   - API å¯†é’¥ç®¡ç†
   - è¯·æ±‚é™æµ
   - å·¥å…·æƒé™æ§åˆ¶

---

## ğŸ“ æ¶æ„è®¾è®¡äº®ç‚¹

### 1. å•ä¸€èŒè´£
- `Planner`: åªè´Ÿè´£æ„å›¾è¯†åˆ«
- `ParameterResolver`: åªè´Ÿè´£å‚æ•°è§£æ
- `Executor`: åªè´Ÿè´£å·¥å…·è°ƒç”¨
- `LLM Generator`: åªè´Ÿè´£ç”Ÿæˆå›ç­”

### 2. å¼€é—­åŸåˆ™
- å¯¹æ‰©å±•å¼€æ”¾ï¼šé€šè¿‡æ³¨å†Œè¡¨æ·»åŠ æ–°å·¥å…·
- å¯¹ä¿®æ”¹å°é—­ï¼šæ ¸å¿ƒé€»è¾‘æ— éœ€æ”¹åŠ¨

### 3. ä¾èµ–å€’ç½®
- é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—
- éƒ½ä¾èµ–äºæŠ½è±¡ï¼ˆå·¥å…·æ¥å£ï¼‰

### 4. æ¥å£éš”ç¦»
- çœŸå®å·¥å…·å’Œ Mock å·¥å…·å®ç°ç›¸åŒæ¥å£
- å¯æ— ç¼åˆ‡æ¢

---

## âœ… éªŒæ”¶æ ‡å‡†

- [x] V2 ç«¯ç‚¹æ­£å¸¸å“åº”
- [x] çœŸå®å·¥å…·æ•°æ®æ­£ç¡®
- [x] Mock å·¥å…·å›é€€æ­£å¸¸
- [x] æ‰§è¡Œè¿½è¸ªè¯¦ç»†å‡†ç¡®
- [x] å‘åå…¼å®¹ V1
- [x] æ–‡æ¡£é½å…¨
- [x] æµ‹è¯•è„šæœ¬å®Œæ•´

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Agent æ¶æ„è®¾è®¡](./agent-design.md)
- [Agent å®æ–½è·¯çº¿å›¾](./agent-implementation-roadmap.md)
- [å¿«é€Ÿå¼€å§‹æŒ‡å—](../AGENT_QUICK_START.md)
- [ç³»ç»ŸæŠ€æœ¯è®¾è®¡](./sport-agent-tech-design.md)

---

## ğŸ™ æ€»ç»“

Agent V2.0 é›†æˆæˆåŠŸå®ç°äº†ï¼š
1. âœ… ç»Ÿä¸€æ¶æ„ï¼ˆOrchestratoræ¨¡å¼ï¼‰
2. âœ… çœŸå®å·¥å…·é›†æˆï¼ˆMatchToolï¼‰
3. âœ… æ™ºèƒ½è·¯ç”±æœºåˆ¶
4. âœ… å‘åå…¼å®¹æ€§
5. âœ… è¯¦ç»†æ‰§è¡Œè¿½è¸ª

è¿™ä¸ºåç»­æ·»åŠ æ›´å¤šçœŸå®å·¥å…·ï¼ˆStats, News, Predictionï¼‰å¥ å®šäº†åšå®åŸºç¡€ã€‚

---

**æ–‡æ¡£ç»´æŠ¤**: Sport Agent Team  
**æœ€åæ›´æ–°**: 2025-11-24  
**ç‰ˆæœ¬**: v2.0.0

