# 交互式聊天测试指南

## 快速启动

### 1. 确保环境准备就绪

```bash
# 激活虚拟环境
cd "/Users/dylan/Desktop/sport agent mvp"
source .venv/bin/activate

# 确保 PostgreSQL 运行
brew services list | grep postgresql

# 确保 Ollama 运行
ollama list

# 设置 LLM 模型（如果需要）
export LLM_MODEL="qwen2.5:7b"
```

### 2. 启动交互式聊天

```bash
python scripts/chat_interactive.py
```

### 3. 开始对话

启动后你会看到：

```
============================================================
Sport Agent V3 交互式测试
============================================================

提示：
  - 输入你的问题进行测试
  - 输入 'exit' 或 'quit' 退出
  - 输入 'clear' 清屏

示例问题：
  - 曼联最近5场比赛战绩如何？
  - 阿森纳对曼城谁会赢？
  - 曼联和利物浦谁更强？为什么？
  - 英超积分榜前5是谁？

============================================================

你: 
```

## 测试场景

### 场景1：数据查询（DataStatsAgent）

**测试问题**：
```
你: 曼联最近5场比赛战绩如何？
```

**预期响应**：
- 调用 DataStatsAgent
- 返回最近5场比赛记录
- 包含胜平负统计

---

### 场景2：比赛预测（PredictionAgent）

**测试问题**：
```
你: 阿森纳对曼城谁会赢？
```

**预期响应**：
- 调用 PredictionAgent
- 返回预测概率（主胜/平局/客胜）
- 列出关键影响因素

---

### 场景3：综合分析（SupervisorAgent）

**测试问题**：
```
你: 曼联和利物浦谁更强？为什么？
```

**预期响应**：
- SupervisorAgent 自动调度
- 调用 DataStatsAgent 获取双方数据
- 综合分析并给出结论
- 提供详细理由

---

### 场景4：积分榜查询

**测试问题**：
```
你: 英超积分榜前5是谁？
```

**预期响应**：
- 查询当前积分榜
- 返回前5名球队
- 包含积分等信息

---

### 场景5：主客场分析

**测试问题**：
```
你: 曼联的主场战绩怎么样？
```

**预期响应**：
- 分析主场比赛记录
- 统计主场胜率
- 对比主客场表现

---

### 场景6：历史交锋

**测试问题**：
```
你: 曼联和切尔西历史交锋记录
```

**预期响应**：
- 查询历史对战记录
- 统计胜负关系
- 分析克制情况

---

## 命令说明

### 对话命令

| 命令 | 功能 |
|------|------|
| 输入问题 | 发送问题给 Agent |
| `exit` / `quit` / `q` | 退出程序 |
| `clear` / `cls` | 清屏 |

### 快捷键

| 快捷键 | 功能 |
|--------|------|
| `Ctrl+C` | 中断当前对话/退出 |
| `Ctrl+D` | 结束输入/退出 |

---

## 测试技巧

### 1. 从简单到复杂

```
第1步：简单查询
你: 曼联最近战绩

第2步：具体查询
你: 曼联最近5场比赛战绩如何？

第3步：复杂分析
你: 曼联和利物浦对比分析，谁更有优势？
```

### 2. 测试不同意图

**数据查询**：
- "曼联最近比赛"
- "英超积分榜"
- "切尔西球队信息"

**预测分析**：
- "阿森纳对曼城"
- "预测利物浦对热刺"
- "谁会赢"

**对比分析**：
- "曼联和利物浦谁更强"
- "对比阿森纳和切尔西"
- "哪个球队状态更好"

### 3. 测试边界情况

**模糊查询**：
```
你: 曼联
```

**多轮对话**：
```
你: 曼联最近状态如何？
Agent: [回答]

你: 那利物浦呢？
Agent: [回答]
```

**复杂问题**：
```
你: 曼联最近5场比赛战绩怎么样？主客场表现有什么区别？和利物浦比谁更强？
```

---

## 常见问题

### Q1: 启动失败

**错误**: `ModuleNotFoundError`

**解决**:
```bash
# 确保虚拟环境激活
source .venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

---

### Q2: 数据库连接失败

**错误**: `could not connect to server`

**解决**:
```bash
# 启动 PostgreSQL
brew services start postgresql@15

# 验证连接
python scripts/check_database_status.py
```

---

### Q3: LLM 模型错误

**错误**: `model 'xxx' not found`

**解决**:
```bash
# 查看可用模型
ollama list

# 设置模型
export LLM_MODEL="qwen2.5:7b"

# 或拉取模型
ollama pull qwen2.5:7b
```

---

### Q4: 响应很慢

**原因**: 
- LLM 模型较大
- 首次查询需要初始化
- 数据库查询复杂

**优化**:
- 使用更小的模型（如 qwen2.5:3b）
- 后续查询会更快（有缓存）

---

### Q5: Agent 不理解问题

**现象**: 返回"无法理解"或错误答案

**解决**:
- 使用更明确的问题
- 包含关键词（球队名、比赛、预测等）
- 参考示例问题格式

---

## 输出说明

### 正常响应格式

```
你: 曼联最近5场比赛战绩如何？

Agent: 正在处理...
------------------------------------------------------------

曼联最近5场比赛战绩：

1. 2024-11-23 曼联 3-0 莱斯特城（主场胜）
2. 2024-11-10 曼联 1-3 布莱顿（客场负）
3. 2024-11-03 曼联 2-0 切尔西（主场胜）
4. 2024-10-27 曼联 1-1 西汉姆（客场平）
5. 2024-10-19 曼联 0-2 利物浦（主场负）

战绩总结：2胜1平2负，胜率40%
------------------------------------------------------------
[会话 1 完成]
```

### 错误响应格式

```
你: 不存在的球队

Agent: 正在处理...
------------------------------------------------------------

错误：无法找到球队"不存在的球队"
------------------------------------------------------------
[会话 1 失败]
```

---

## 性能参考

| 操作 | 预期时间 |
|------|---------|
| 简单查询 | 5-10秒 |
| 预测分析 | 10-15秒 |
| 综合分析 | 20-30秒 |
| 首次启动 | 额外 5秒（初始化）|

---

## 进阶使用

### 批量测试

创建测试脚本：

```python
# test_questions.py
import asyncio
from src.services.agent_service_v3 import ask

questions = [
    "曼联最近5场比赛战绩如何？",
    "阿森纳对曼城谁会赢？",
    "英超积分榜前5是谁？",
]

async def batch_test():
    for i, q in enumerate(questions, 1):
        print(f"\n{i}. 问题: {q}")
        answer = await ask(q)
        print(f"   回答: {answer[:100]}...")

asyncio.run(batch_test())
```

### 性能分析

```python
import time
import asyncio
from src.services.agent_service_v3 import ask

async def performance_test():
    query = "曼联最近战绩"
    
    start = time.time()
    answer = await ask(query)
    duration = time.time() - start
    
    print(f"查询: {query}")
    print(f"耗时: {duration:.2f}秒")
    print(f"回答长度: {len(answer)} 字符")

asyncio.run(performance_test())
```

---

## 退出程序

任意以下方式退出：

```bash
# 方式1：输入退出命令
你: exit

# 方式2：使用快捷键
Ctrl+C

# 方式3：输入结束符
Ctrl+D
```

---

## 下一步

测试完成后：

1. **查看日志**（如果有）
2. **验证数据库**：`python scripts/check_database_status.py`
3. **查看技术文档**：`docs/SportAgent_TechSpec_v2_FULL.md`
4. **报告问题**：记录异常情况

---

**祝测试顺利！**

如有问题，查看 `QUICK_START.md` 或技术文档。

